<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beaty Service - RECOMMEND Pipeline Test</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ì™¼ìª½: ê²€ìƒ‰ ì˜ì—­ */
        .left-panel {
            width: 30%;
            background: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }

        /* ì¤‘ê°„: JSON ê²°ê³¼ ì˜ì—­ */
        .center-panel {
            width: 35%;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }

        /* ì˜¤ë¥¸ìª½: ì§€ë„ ì˜ì—­ */
        .right-panel {
            width: 35%;
            position: relative;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .steps-container {
            margin-top: 30px;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }

        .steps-container.visible {
            display: block;
        }

        .step-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }

        .step-card.active {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .step-card.loading {
            border-color: #ffc107;
            background: #fff9e6;
        }

        .step-card.success {
            border-color: #28a745;
        }

        .step-card.error {
            border-color: #dc3545;
            background: #ffe6e6;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .step-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            background: #e0e0e0;
            color: #666;
        }

        .step-status.loading {
            background: #ffc107;
            color: white;
        }

        .step-status.success {
            background: #28a745;
            color: white;
        }

        .step-status.error {
            background: #dc3545;
            color: white;
        }

        #jsonResult {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .json-placeholder {
            color: #666;
            text-align: center;
            padding: 40px;
            font-size: 14px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì™¼ìª½: ê²€ìƒ‰ ì˜ì—­ -->
        <div class="left-panel">
            <h1>ğŸ¤– Beaty Test</h1>

            <div class="input-group">
                <label>ì§ˆë¬¸</label>
                <textarea id="queryInput" placeholder="ì˜ˆ: í™ëŒ€ ë§›ì§‘ ì¶”ì²œí•´ì¤˜"></textarea>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>ìœ„ë„ (Latitude)</label>
                    <input type="number" id="userLat" value="37.5665" step="0.0001">
                </div>
                <div class="input-group">
                    <label>ê²½ë„ (Longitude)</label>
                    <input type="number" id="userLng" value="126.9780" step="0.0001">
                </div>
            </div>

            <button class="btn" id="runBtn" onclick="runPipeline()">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰</button>

            <div class="steps-container" id="stepsContainer">
                <!-- Step ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
        </div>

        <!-- ì¤‘ê°„: JSON ê²°ê³¼ -->
        <div class="center-panel">
            <div id="jsonResult" class="json-placeholder">
                íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ê±°ë‚˜ Step ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´<br>
                JSON ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì§€ë„ -->
        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>

    <script>
        // Mapbox ì´ˆê¸°í™”
        mapboxgl.accessToken = 'pk.eyJ1IjoieWVhaGhhIiwiYSI6ImNtZTk4bTY2czBvcjUya29pc2NmdzM2aDQifQ.Nv8VEnrxJ5BDqBDOHH518Q';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [126.9780, 37.5665],
            zoom: 12
        });

        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
        let userLocationMarker = null;

        // ì§€ë„ í´ë¦­ìœ¼ë¡œ í˜„ì¬ ìœ„ì¹˜ ì„¤ì •
        map.on('click', (e) => {
            const { lng, lat } = e.lngLat;

            // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('userLat').value = lat.toFixed(4);
            document.getElementById('userLng').value = lng.toFixed(4);

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            if (userLocationMarker) {
                userLocationMarker.remove();
            }

            // ìƒˆ ë§ˆì»¤ ìƒì„±
            const el = document.createElement('div');
            el.style.width = '30px';
            el.style.height = '30px';
            el.style.backgroundColor = '#007bff';
            el.style.borderRadius = '50%';
            el.style.border = '3px solid white';
            el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            el.style.cursor = 'pointer';

            userLocationMarker = new mapboxgl.Marker(el)
                .setLngLat([lng, lat])
                .setPopup(
                    new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div style="font-size: 13px;">
                            <strong>í˜„ì¬ ìœ„ì¹˜</strong><br>
                            ìœ„ë„: ${lat.toFixed(4)}<br>
                            ê²½ë„: ${lng.toFixed(4)}
                        </div>
                    `)
                )
                .addTo(map);
        });

        // ìƒíƒœ ê´€ë¦¬
        const state = {
            steps: [],
            currentStepIndex: null,
            currentIntent: null
        };

        const stepDefinitions = {
            'RECOMMEND': [
                { step: 1, name: 'ì˜ë„ë¶„ë¥˜', key: 'classification' },
                { step: 2, name: 'ìœ„ì¹˜ í•´ê²°', key: 'position' },
                { step: 3, name: 'ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸', key: 'rewrite' },
                { step: 4, name: 'ì¶”ì²œê²€ìƒ‰', key: 'recommend' },
                { step: 5, name: 'ìµœì¢…ì‘ë‹µ', key: 'final_response' }
            ],
            'FIND_PLACE': [
                { step: 1, name: 'ì˜ë„ë¶„ë¥˜', key: 'classification' },
                { step: 2, name: 'ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸ (FIND_PLACE)', key: 'rewrite' },
                { step: 3, name: 'ì¥ì†Œê²€ìƒ‰ (Google Places)', key: 'search' },
                { step: 4, name: 'ìµœì¢…ì‘ë‹µ', key: 'final_response' }
            ],
            'LANDMARK': [
                { step: 1, name: 'ì˜ë„ë¶„ë¥˜', key: 'classification' },
                { step: 2, name: 'ìœ„ì¹˜ í‚¤ì›Œë“œ ì¶”ì¶œ', key: 'location' },
                { step: 3, name: 'ëœë“œë§ˆí¬ ì¡°íšŒ', key: 'landmark' },
                { step: 4, name: 'ìµœì¢…ì‘ë‹µ', key: 'final_response' }
            ],
            'ROUTE': [
                { step: 1, name: 'ì˜ë„ë¶„ë¥˜', key: 'classification' },
                { step: 2, name: 'ì¶œë°œì§€/ë„ì°©ì§€ ì¶”ì¶œ', key: 'extract_locations' },
                { step: 3, name: 'ì¢Œí‘œë³€í™˜ (Geocoding)', key: 'geocoding' },
                { step: 4, name: 'ê²½ë¡œê²€ìƒ‰', key: 'route_search' },
                { step: 5, name: 'ìµœì¢…ì‘ë‹µ', key: 'final_response' }
            ]
        };

        // Step ì¹´ë“œ ìƒì„± (ì˜ë„ ì „í™˜ í¬í•¨)
        function createStepCards(intent) {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = '';
            container.classList.add('visible');

            state.currentIntent = intent;

            // ì˜ë„ ì „í™˜ì´ ìˆëŠ”ì§€ í™•ì¸
            const intentChangeStep = state.steps.find(s =>
                s.name && s.name.includes('ì˜ë„ ì „í™˜')
            );

            // Google Places í´ë°±ì´ ìˆëŠ”ì§€ í™•ì¸
            const googleFallbackStep = state.steps.find(s =>
                s.name && s.name.includes('Google Places í´ë°±')
            );

            // ë™ì  ëª¨ë“œ: ì˜ë„ ì „í™˜ ë˜ëŠ” Google í´ë°±ì´ ìˆìœ¼ë©´ ëª¨ë“  stepì„ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œ
            if (intentChangeStep || googleFallbackStep) {
                // ì˜ë„ ì „í™˜ì´ ìˆìœ¼ë©´ ëª¨ë“  stepì„ ìˆœì°¨ì ìœ¼ë¡œ í‘œì‹œ
                state.steps.forEach((step, index) => {
                    // error stepì€ ì œì™¸
                    if (step.step === 'error') return;

                    const card = document.createElement('div');
                    card.className = 'step-card';
                    card.id = `step-card-${index}`;

                    // Step ë²ˆí˜¸ì™€ ì´ë¦„ í‘œì‹œ
                    const stepLabel = typeof step.step === 'number' ? `Step ${step.step}` : step.step;

                    card.innerHTML = `
                        <div class="step-header">
                            <div class="step-title">${stepLabel}: ${step.name}</div>
                            <div class="step-status" id="step-status-${index}">ì™„ë£Œ</div>
                        </div>
                    `;

                    card.onclick = () => showStepResult(index);
                    container.appendChild(card);
                });
            } else {
                // ì¼ë°˜ì ì¸ ê²½ìš°: stepDefinitions ì‚¬ìš©
                const stepDefs = stepDefinitions[intent] || stepDefinitions['RECOMMEND'];

                stepDefs.forEach((stepDef, defIndex) => {
                    const card = document.createElement('div');
                    card.className = 'step-card';
                    card.id = `step-card-${stepDef.step}`;
                    card.innerHTML = `
                        <div class="step-header">
                            <div class="step-title">Step ${stepDef.step}: ${stepDef.name}</div>
                            <div class="step-status" id="step-status-${stepDef.step}">ëŒ€ê¸°</div>
                        </div>
                    `;

                    card.onclick = () => {
                        const actualIndex = state.steps.findIndex(s =>
                            s.step === stepDef.step && s.name === stepDef.name
                        );
                        if (actualIndex >= 0) {
                            showStepResult(actualIndex);
                        }
                    };

                    container.appendChild(card);
                });
            }
        }

        // Step ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStepStatus(stepNum, status) {
            // ì˜ë„ ì „í™˜ì´ ìˆìœ¼ë©´ index ê¸°ë°˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            const intentChangeStep = state.steps.find(s =>
                s.name && s.name.includes('ì˜ë„ ì „í™˜')
            );

            let card, statusEl;

            if (intentChangeStep) {
                // ì˜ë„ ì „í™˜ ëª¨ë“œ: state.stepsì—ì„œ í•´ë‹¹ step ì°¾ê¸°
                const stepIndex = state.steps.findIndex(s => s.step === stepNum);
                if (stepIndex >= 0) {
                    card = document.getElementById(`step-card-${stepIndex}`);
                    statusEl = document.getElementById(`step-status-${stepIndex}`);
                }
            } else {
                // ì¼ë°˜ ëª¨ë“œ
                card = document.getElementById(`step-card-${stepNum}`);
                statusEl = document.getElementById(`step-status-${stepNum}`);
            }

            // ì¹´ë“œë‚˜ ìƒíƒœ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
            if (!card || !statusEl) {
                return;
            }

            card.className = 'step-card ' + status;
            statusEl.className = 'step-status ' + status;

            if (status === 'loading') {
                statusEl.innerHTML = '<span class="loading-spinner"></span>';
            } else if (status === 'success') {
                statusEl.textContent = 'ì™„ë£Œ';
            } else if (status === 'error') {
                statusEl.textContent = 'ì˜¤ë¥˜';
            }
        }

        // Step ê²°ê³¼ í‘œì‹œ
        function showStepResult(index) {
            if (!state.steps[index]) {
                console.warn(`Cannot show step result for index ${index}`);
                return;
            }

            // ëª¨ë“  ì¹´ë“œì˜ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
            });

            // ì„ íƒëœ ì¹´ë“œì— active ì¶”ê°€
            const card = document.getElementById(`step-card-${index}`);
            if (card) {
                card.classList.add('active');
            }

            const stepData = state.steps[index];

            // ìµœì¢… ì‘ë‹µì¸ ê²½ìš° íŠ¹ë³„ í¬ë§·íŒ…
            if (stepData.name === 'ìµœì¢…ì‘ë‹µ' && stepData.result && stepData.result.answer) {
                showFinalAnswer(stepData.result);
            } else {
                // ì¼ë°˜ JSON ê²°ê³¼ í‘œì‹œ
                showJSON(stepData.result);
            }

            state.currentStepIndex = index;
        }

        // ìµœì¢… ì‘ë‹µ í‘œì‹œ (íŠ¹ë³„ í¬ë§·íŒ…)
        function showFinalAnswer(data) {
            // ê·¸ëƒ¥ ì¼ë°˜ JSONìœ¼ë¡œ í‘œì‹œ
            showJSON(data);
        }

        // JSON í‘œì‹œ
        function showJSON(data) {
            const jsonResult = document.getElementById('jsonResult');
            jsonResult.className = '';
            jsonResult.textContent = JSON.stringify(data, null, 2);
        }

        // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
        async function runPipeline() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const lat = parseFloat(document.getElementById('userLat').value);
            const lng = parseFloat(document.getElementById('userLng').value);

            // ì´ˆê¸°í™”
            state.steps = [];
            state.currentStepIndex = null;
            document.getElementById('jsonResult').innerHTML = '<div class="json-placeholder">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘...</div>';

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.textContent = 'ì‹¤í–‰ ì¤‘...';

            try {
                // /api/query í˜¸ì¶œ (mode=test)
                const response = await fetch('http://localhost:8000/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        user_location: { lat, lng },
                        mode: 'test'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Pipeline result:', result);

                // ì‹¤ì œ intent í™•ì¸
                const actualIntent = result.intent;

                // steps ì €ì¥ (ë¨¼ì €!)
                state.steps = result.steps || [];
                console.log('Steps:', state.steps);

                // Step ì¹´ë“œ ìƒì„± (state.stepsê°€ ì„¤ì •ëœ í›„)
                createStepCards(actualIntent);

                // Step ì¹´ë“œ ì—…ë°ì´íŠ¸
                state.steps.forEach((step, index) => {
                    // stepê³¼ step.stepì´ ìœ íš¨í•œ ê²½ìš°ë§Œ ì—…ë°ì´íŠ¸
                    if (step && typeof step.step === 'number') {
                        updateStepStatus(step.step, 'success');
                    }
                });

                // ì²« ë²ˆì§¸ step ìë™ ì„ íƒ
                if (state.steps.length > 0) {
                    showStepResult(0);
                }

                // ì§€ë„ì— POI/Places/Routes/Landmarks í‘œì‹œ
                if (result.final_response) {
                    if (result.final_response.pois) {
                        displayPOIsOnMap(result.final_response.pois);
                    } else if (result.final_response.places) {
                        displayPlacesOnMap(result.final_response.places);
                    } else if (result.final_response.landmarks) {
                        displayLandmarksOnMap(result.final_response.landmarks);
                    } else if (result.final_response.routes) {
                        // ROUTE ì˜ë„: final_responseì—ì„œ ì§ì ‘ geojson ê°€ì ¸ì˜¤ê¸°
                        if (result.final_response.geojson) {
                            displayRouteOnMap(result.final_response.geojson);
                        }
                    }
                }

            } catch (error) {
                console.error('Pipeline error:', error);
                alert('íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
                document.getElementById('jsonResult').innerHTML = `<div class="json-placeholder" style="color: #dc3545;">ì˜¤ë¥˜: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'íŒŒì´í”„ë¼ì¸ ì‹¤í–‰';
            }
        }

        // ì§€ë„ì— POI í‘œì‹œ
        function displayPOIsOnMap(pois) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            const existingMarkers = document.querySelectorAll('.mapboxgl-marker');
            existingMarkers.forEach(marker => marker.remove());

            if (!pois || pois.length === 0) return;

            const bounds = new mapboxgl.LngLatBounds();

            pois.forEach((poi, index) => {
                if (!poi.mapx || !poi.mapy) return;

                // keyword_match_count > 0 ì´ë©´ ë¹¨ê°„ìƒ‰, ì•„ë‹ˆë©´ íŒŒë€ìƒ‰
                const hasKeywordMatch = poi.keyword_match_count && poi.keyword_match_count > 0;
                const markerColor = hasKeywordMatch ? '#dc3545' : '#007bff';

                // ë§ˆì»¤ ìƒì„±
                const el = document.createElement('div');
                el.style.width = '30px';
                el.style.height = '30px';
                el.style.backgroundColor = markerColor;
                el.style.borderRadius = '50%';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                el.style.justifyContent = 'center';
                el.style.color = 'white';
                el.style.fontWeight = 'bold';
                el.style.fontSize = '12px';
                el.textContent = index + 1;

                // íŒì—… ìƒì„±
                const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                    <div style="font-size: 13px;">
                        <strong>${poi.title || poi.name || 'N/A'}</strong><br>
                        ${poi.addr1 || poi.address || 'N/A'}<br>
                        ${poi.keyword_match_count > 0 ? `<span style="color: #dc3545; font-weight: bold;">ğŸ¯ í‚¤ì›Œë“œ ë§¤ì¹­: ${poi.keyword_match_count}ê°œ</span><br>` : ''}
                        ${poi.emotion_score ? `ê°ì •ì ìˆ˜: ${poi.emotion_score.toFixed(2)}<br>` : ''}
                        ${poi.distance_km ? `ê±°ë¦¬: ${poi.distance_km.toFixed(2)}km` : ''}
                    </div>
                `);

                new mapboxgl.Marker(el)
                    .setLngLat([poi.mapx, poi.mapy])
                    .setPopup(popup)
                    .addTo(map);

                bounds.extend([poi.mapx, poi.mapy]);
            });

            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (pois.length > 0) {
                map.fitBounds(bounds, { padding: 50 });
            }
        }

        // ì§€ë„ì— Places í‘œì‹œ (FIND_PLACEìš©)
        function displayPlacesOnMap(places) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            const existingMarkers = document.querySelectorAll('.mapboxgl-marker');
            existingMarkers.forEach(marker => marker.remove());

            if (!places || places.length === 0) return;

            const bounds = new mapboxgl.LngLatBounds();

            places.forEach((place, index) => {
                if (!place.lng || !place.lat) return;

                // FIND_PLACEëŠ” keyword_match_count ì—†ìŒ - í•­ìƒ íŒŒë€ìƒ‰
                const markerColor = '#007bff';

                // ë§ˆì»¤ ìƒì„±
                const el = document.createElement('div');
                el.style.width = '30px';
                el.style.height = '30px';
                el.style.backgroundColor = markerColor;
                el.style.borderRadius = '50%';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                el.style.justifyContent = 'center';
                el.style.color = 'white';
                el.style.fontWeight = 'bold';
                el.style.fontSize = '12px';
                el.textContent = index + 1;

                // íŒì—… ìƒì„±
                const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                    <div style="font-size: 13px;">
                        <strong>${place.name || 'N/A'}</strong><br>
                        ${place.address || 'N/A'}<br>
                        ${place.rating ? `í‰ì : â­ ${place.rating}` : ''}
                    </div>
                `);

                new mapboxgl.Marker(el)
                    .setLngLat([place.lng, place.lat])
                    .setPopup(popup)
                    .addTo(map);

                bounds.extend([place.lng, place.lat]);
            });

            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (places.length > 0) {
                map.fitBounds(bounds, { padding: 50 });
            }
        }

        // ì§€ë„ì— Landmarks í‘œì‹œ (LANDMARKìš©)
        function displayLandmarksOnMap(landmarks) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            const existingMarkers = document.querySelectorAll('.mapboxgl-marker');
            existingMarkers.forEach(marker => marker.remove());

            if (!landmarks || landmarks.length === 0) return;

            const bounds = new mapboxgl.LngLatBounds();

            landmarks.forEach((landmark) => {
                if (!landmark.mapx || !landmark.mapy) return;

                // ëœë“œë§ˆí¬ëŠ” ë³´ë¼ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                const markerColor = '#6f42c1';

                // ë§ˆì»¤ ìƒì„± (rank ìˆ«ì í‘œì‹œ)
                const el = document.createElement('div');
                el.style.width = '35px';
                el.style.height = '35px';
                el.style.backgroundColor = markerColor;
                el.style.borderRadius = '50%';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                el.style.justifyContent = 'center';
                el.style.color = 'white';
                el.style.fontWeight = 'bold';
                el.style.fontSize = '13px';
                el.textContent = landmark.rank || '?';

                // íŒì—… ìƒì„±
                let popupHtml = `
                    <div style="font-size: 13px; max-width: 250px;">
                        <strong>${landmark.title || 'N/A'}</strong><br>
                        ${landmark.addr1 ? `ğŸ“ ${landmark.addr1}<br>` : ''}
                `;

                // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (landmark.first_image) {
                    popupHtml += `
                        <div style="margin-top: 8px;">
                            <img src="${landmark.first_image}"
                                 style="width: 100%; max-width: 250px; border-radius: 6px; object-fit: cover;"
                                 onerror="this.style.display='none'">
                        </div>
                    `;
                }

                if (landmark.description) {
                    popupHtml += `<div style="margin-top: 5px; color: #666;">ğŸ’¬ ${landmark.description}</div>`;
                }

                popupHtml += `</div>`;

                const popup = new mapboxgl.Popup({ offset: 30 }).setHTML(popupHtml);

                new mapboxgl.Marker(el)
                    .setLngLat([landmark.mapx, landmark.mapy])
                    .setPopup(popup)
                    .addTo(map);

                bounds.extend([landmark.mapx, landmark.mapy]);
            });

            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (landmarks.length > 0) {
                map.fitBounds(bounds, { padding: 50 });
            }
        }

        // ì§€ë„ì— ê²½ë¡œ í‘œì‹œ (ROUTEìš©)
        function displayRouteOnMap(geojson) {
            // ê¸°ì¡´ ë§ˆì»¤/ë ˆì´ì–´ ì œê±°
            const existingMarkers = document.querySelectorAll('.mapboxgl-marker');
            existingMarkers.forEach(marker => marker.remove());

            // ê¸°ì¡´ ê²½ë¡œ ë ˆì´ì–´ë“¤ ì œê±°
            const layers = map.getStyle().layers;
            layers.forEach(layer => {
                if (layer.id.startsWith('route-line-')) {
                    map.removeLayer(layer.id);
                }
            });

            const sources = Object.keys(map.getStyle().sources);
            sources.forEach(source => {
                if (source.startsWith('route-')) {
                    map.removeSource(source);
                }
            });

            if (!geojson || !geojson.features) return;

            const bounds = new mapboxgl.LngLatBounds();

            // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (11ê°œ ì´ìƒ)
            const routeColors = [
                '#007bff',  // íŒŒë€ìƒ‰ (ì²« ë²ˆì§¸ ê²½ë¡œ - ì¶”ì²œ)
                '#dc3545',  // ë¹¨ê°„ìƒ‰
                '#28a745',  // ë…¹ìƒ‰
                '#ffc107',  // ë…¸ë€ìƒ‰
                '#17a2b8',  // ì²­ë¡ìƒ‰
                '#6f42c1',  // ë³´ë¼ìƒ‰
                '#fd7e14',  // ì£¼í™©ìƒ‰
                '#e83e8c',  // ë¶„í™ìƒ‰
                '#20c997',  // ë¯¼íŠ¸ìƒ‰
                '#6c757d',  // íšŒìƒ‰
                '#343a40',  // ì–´ë‘ìš´ íšŒìƒ‰
                '#f8f9fa',  // ë°ì€ íšŒìƒ‰
            ];

            geojson.features.forEach(feature => {
                const props = feature.properties;

                if (feature.geometry.type === 'Point') {
                    // ì¶œë°œì§€/ë„ì°©ì§€ ë§ˆì»¤
                    const isOrigin = props.type === 'origin';
                    const markerColor = isOrigin ? '#28a745' : '#dc3545';
                    const label = isOrigin ? 'ì¶œë°œ' : 'ë„ì°©';

                    const el = document.createElement('div');
                    el.style.width = '40px';
                    el.style.height = '40px';
                    el.style.backgroundColor = markerColor;
                    el.style.borderRadius = '50%';
                    el.style.border = '3px solid white';
                    el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.justifyContent = 'center';
                    el.style.color = 'white';
                    el.style.fontWeight = 'bold';
                    el.style.fontSize = '11px';
                    el.textContent = label;

                    const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                        <div style="font-size: 13px;">
                            <strong>${props.name}</strong>
                        </div>
                    `);

                    new mapboxgl.Marker(el)
                        .setLngLat(feature.geometry.coordinates)
                        .setPopup(popup)
                        .addTo(map);

                    bounds.extend(feature.geometry.coordinates);
                }
            });

            // ê²½ë¡œ ë¼ì¸ë“¤ ê·¸ë¦¬ê¸° (ê°ê° ë‹¤ë¥¸ ìƒ‰ìƒ)
            const routeLines = geojson.features.filter(f => f.geometry.type === 'LineString');

            routeLines.forEach((routeLine, index) => {
                const routeIndex = routeLine.properties.routeIndex || index;
                const color = routeColors[routeIndex % routeColors.length];
                const isFirstRoute = routeIndex === 0;

                // ê° ê²½ë¡œë³„ë¡œ sourceì™€ layer ìƒì„±
                const sourceId = `route-${routeIndex}`;
                const layerId = `route-line-${routeIndex}`;

                map.addSource(sourceId, {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: routeLine.geometry
                    }
                });

                map.addLayer({
                    id: layerId,
                    type: 'line',
                    source: sourceId,
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': color,
                        'line-width': isFirstRoute ? 5 : 3,  // ì²« ë²ˆì§¸ ê²½ë¡œëŠ” ë” êµµê²Œ
                        'line-opacity': isFirstRoute ? 0.9 : 0.6
                    }
                });

                // ê²½ë¡œ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ
                map.on('click', layerId, (e) => {
                    const props = routeLine.properties;
                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div style="font-size: 13px;">
                                <strong>ê²½ë¡œ ${routeIndex + 1}</strong><br>
                                ì†Œìš”ì‹œê°„: ${props.totalTime}ë¶„<br>
                                ìš”ê¸ˆ: ${props.payment.toLocaleString()}ì›<br>
                                ê±°ë¦¬: ${(props.totalDistance / 1000).toFixed(1)}km
                            </div>
                        `)
                        .addTo(map);
                });

                // ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½
                map.on('mouseenter', layerId, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                map.on('mouseleave', layerId, () => {
                    map.getCanvas().style.cursor = '';
                });

                // bounds í™•ì¥
                routeLine.geometry.coordinates.forEach(coord => {
                    bounds.extend(coord);
                });
            });

            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, { padding: 80 });
            }
        }

        // Enter í‚¤ë¡œ ì‹¤í–‰
        document.getElementById('queryInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                runPipeline();
            }
        });
    </script>
</body>
</html>
