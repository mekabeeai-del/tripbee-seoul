<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beaty Service - Test UI (Standalone)</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0;
            display: flex;
            gap: 15px;
            height: 100vh;
            padding: 15px;
        }

        .left-panel {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .right-panel {
            flex: 2;
            overflow-y: auto;
            padding-left: 5px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header .badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .input-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-inputs {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .location-inputs .input-group {
            flex: 1;
        }

        .pipeline-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-card {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .step-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateX(3px);
        }

        .step-card.active {
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            border-left: 4px solid #667eea;
            padding-left: 11px;
            background: linear-gradient(90deg, #f0f4ff 0%, #ffffff 100%);
        }

        .step-card .step-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .step-card h3 {
            font-size: 0.95em;
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
        }

        .step-card .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-size: 0.85em;
            margin-right: 10px;
            font-weight: bold;
        }


        .step-card .status {
            font-size: 0.85em;
            color: #666;
            padding: 4px 12px;
            border-radius: 12px;
            background: #f3f4f6;
            margin-left: 10px;
        }

        .step-card .status.loading {
            color: #667eea;
            font-weight: bold;
            background: #eef2ff;
        }

        .step-card .status.success {
            color: #10b981;
            font-weight: bold;
            background: #d1fae5;
        }

        .step-card .status.error {
            color: #ef4444;
            font-weight: bold;
            background: #fee2e2;
        }

        .result-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .result-section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .result-tabs {
            display: none;
        }

        .result-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .result-content.active {
            display: flex;
            flex-direction: column;
        }

        .result-split {
            display: flex;
            gap: 15px;
            flex: 1;
            overflow: hidden;
        }

        .result-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .result-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
            overflow: hidden;
        }

        #position-map {
            width: 100% !important;
            height: 100% !important;
            min-height: 400px !important;
        }

        .json-view {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            flex: 1;
            overflow-y: auto;
        }

        .json-view pre {
            margin: 0;
        }

        .prompt-editor {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .prompt-editor h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prompt-editor textarea {
            flex: 1;
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #334155;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            overflow-y: auto;
        }

        .prompt-editor textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-save {
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn-save:hover {
            opacity: 0.85;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Input Section -->
            <div class="input-section">
                <div class="input-group">
                    <label for="userQuery">ì‚¬ìš©ì ì§ˆì˜</label>
                    <input type="text" id="userQuery" placeholder="ì˜ˆ: í™ëŒ€ ë§›ì§‘ ì¶”ì²œí•´ì¤˜" value="í™ëŒ€ ë§›ì§‘ ì¶”ì²œí•´ì¤˜" onkeypress="if(event.key==='Enter') runAll()">
                </div>
                <div class="location-inputs">
                    <div class="input-group">
                        <label for="userLat">ìœ„ë„ (Latitude)</label>
                        <input type="number" id="userLat" placeholder="37.5563" value="37.5563" step="0.0001">
                    </div>
                    <div class="input-group">
                        <label for="userLng">ê²½ë„ (Longitude)</label>
                        <input type="number" id="userLng" placeholder="126.9224" value="126.9224" step="0.0001">
                    </div>
                    <button onclick="openLocationPicker()" style="padding: 12px 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; margin-bottom: 13px; box-sizing: border-box;" title="ì§€ë„ì—ì„œ ì„ íƒ">ğŸ“</button>
                </div>
                <div class="input-group">
                    <button onclick="runAll()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;">ì „ì²´ ì‹¤í–‰</button>
                </div>
            </div>

            <!-- Pipeline Steps -->
            <div class="pipeline-section">
            <!-- Step 1: Intent Classification -->
            <div class="step-card" onclick="showTab('step1')">
                <div class="step-info">
                    <h3><span class="step-number">1</span> ì˜ë„ë¶„ë¥˜</h3>
                </div>
                <div class="status" id="status1">ëŒ€ê¸°ì¤‘</div>
            </div>

            <!-- Step 2: Category Resolution -->
            <div class="step-card" onclick="showTab('step2')">
                <div class="step-info">
                    <h3><span class="step-number">2</span> ì¹´í…Œê³ ë¦¬</h3>
                </div>
                <div class="status" id="status2">ëŒ€ê¸°ì¤‘</div>
            </div>

            <!-- Step 3: Position Resolution -->
            <div class="step-card" onclick="showTab('step3')">
                <div class="step-info">
                    <h3><span class="step-number">3</span> ê±°ì ìœ„ì¹˜</h3>
                </div>
                <div class="status" id="status3">ëŒ€ê¸°ì¤‘</div>
            </div>

            <!-- Step 4: Query Rewrite -->
            <div class="step-card" onclick="showTab('step4')">
                <div class="step-info">
                    <h3><span class="step-number">4</span> ì¿¼ë¦¬ë¦¬ë¼ì´íŠ¸</h3>
                </div>
                <div class="status" id="status4">ëŒ€ê¸°ì¤‘</div>
            </div>

            <!-- Step 5: Recommend -->
            <div class="step-card" onclick="showTab('step5')">
                <div class="step-info">
                    <h3><span class="step-number">5</span> ì¶”ì²œê²€ìƒ‰</h3>
                </div>
                <div class="status" id="status5">ëŒ€ê¸°ì¤‘</div>
            </div>

            <!-- Step 6: Final Response -->
            <div class="step-card" onclick="showTab('step6')">
                <div class="step-info">
                    <h3><span class="step-number">6</span> ìµœì¢…ì‘ë‹µ</h3>
                </div>
                <div class="status" id="status6">ëŒ€ê¸°ì¤‘</div>
            </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Results Section -->
            <div class="result-section">
                <h2>ê²°ê³¼ ë³´ê¸°</h2>

                <div class="result-tabs">
                    <button class="tab-button" onclick="showTab('step1')" id="tab-step1">Step 1: ì˜ë„ë¶„ë¥˜</button>
                    <button class="tab-button" onclick="showTab('step2')" id="tab-step2">Step 2: ì¹´í…Œê³ ë¦¬</button>
                    <button class="tab-button" onclick="showTab('step3')" id="tab-step3">Step 3: ê±°ì ìœ„ì¹˜</button>
                    <button class="tab-button" onclick="showTab('step4')" id="tab-step4">Step 4: ì¿¼ë¦¬ë¦¬ë¼ì´íŠ¸</button>
                    <button class="tab-button" onclick="showTab('step5')" id="tab-step5">Step 5: ì¶”ì²œê²€ìƒ‰</button>
                    <button class="tab-button" onclick="showTab('step6')" id="tab-step6">Step 6: ìµœì¢…ì‘ë‹µ</button>
                </div>

                <div id="result-step1" class="result-content">
                    <div class="result-split">
                        <div class="result-left">
                            <div class="json-view"><pre id="json-step1">ê²°ê³¼ ì—†ìŒ</pre></div>
                        </div>
                        <div class="result-right">
                            <div class="prompt-editor">
                                <h3>
                                    ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
                                    <button class="btn-save" onclick="saveSystemPrompt()">ì €ì¥</button>
                                </h3>
                                <textarea id="system-prompt-editor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="result-step2" class="result-content">
                    <div class="json-view"><pre id="json-step2">ê²°ê³¼ ì—†ìŒ</pre></div>
                </div>
                <div id="result-step3" class="result-content">
                    <div class="result-split">
                        <div class="result-left">
                            <div class="json-view"><pre id="json-step3">ê²°ê³¼ ì—†ìŒ</pre></div>
                        </div>
                        <div class="result-right">
                            <div id="position-map" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>
                <div id="result-step4" class="result-content">
                    <div class="result-split">
                        <div class="result-left">
                            <div class="json-view"><pre id="json-step4">ê²°ê³¼ ì—†ìŒ</pre></div>
                        </div>
                        <div class="result-right">
                            <div class="prompt-editor">
                                <h3>
                                    ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸ í”„ë¡¬í”„íŠ¸
                                    <button class="btn-save" onclick="saveRewritePrompt()">ì €ì¥</button>
                                </h3>
                                <textarea id="rewrite-prompt-editor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="result-step5" class="result-content">
                    <div class="result-split">
                        <div class="result-left">
                            <div class="json-view"><pre id="json-step5">ê²°ê³¼ ì—†ìŒ</pre></div>
                        </div>
                        <div class="result-right">
                            <div id="recommend-map" style="width: 100%; height: 60%;"></div>
                            <div id="poi-info" style="width: 100%; height: 40%; overflow-y: auto; padding: 15px; background: #f8f9fa;">
                                <h3 style="margin-top: 0;">POI ì •ë³´</h3>
                                <div id="poi-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="result-step6" class="result-content">
                    <div class="json-view"><pre id="json-step6">ê²°ê³¼ ì—†ìŒ</pre></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìœ„ì¹˜ ì„ íƒ ëª¨ë‹¬ -->
    <div id="locationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; width: 80%; height: 80%; max-width: 1000px; max-height: 700px; display: flex; flex-direction: column; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #333;">ğŸ“ ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</h2>
                <button onclick="closeLocationPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">âœ•</button>
            </div>
            <div style="flex: 1; position: relative;">
                <div id="picker-map" style="width: 100%; height: 100%;"></div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; color: #666;">
                    ì„ íƒëœ ìœ„ì¹˜: <span id="selected-coords" style="font-weight: bold; color: #667eea;">ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”</span>
                </div>
                <button onclick="confirmLocation()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // Mapbox ì„¤ì •
        mapboxgl.accessToken = 'pk.eyJ1IjoieWVhaGhhIiwiYSI6ImNtZTk4bTY2czBvcjUya29pc2NmdzM2aDQifQ.Nv8VEnrxJ5BDqBDOHH518Q';
        let positionMap = null;
        let positionMarker = null;
        let recommendMap = null;
        let recommendMarkers = [];

        // ìœ„ì¹˜ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨
        let pickerMap = null;
        let pickerMarker = null;
        let selectedLat = null;
        let selectedLng = null;

        // ì „ì—­ ìƒíƒœ ì €ì¥
        const state = {
            query: '',
            classification: null,
            category: null,
            position: null,
            rewrittenQuery: null,
            recommendations: null,
            finalResponse: null
        };

        // Tab ì „í™˜
        function showTab(tabId) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.result-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`result-${tabId}`).classList.add('active');

            // ì¹´ë“œ í™œì„±í™”
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            const stepNumber = tabId.replace('step', '');
            const cards = document.querySelectorAll('.step-card');
            if (cards[stepNumber - 1]) {
                cards[stepNumber - 1].classList.add('active');
            }

            // Step 3 (ê±°ì ìœ„ì¹˜)ê°€ ì„ íƒë˜ë©´ ì§€ë„ ì´ˆê¸°í™” ë° í‘œì‹œ
            if (tabId === 'step3') {
                setTimeout(() => {
                    initPositionMap();
                    if (positionMap) {
                        positionMap.resize();
                    }
                    if (state.position) {
                        displayPositionOnMap(state.position);
                    }
                }, 200);
            }

            // Step 5 (ì¶”ì²œê²€ìƒ‰)ê°€ ì„ íƒë˜ë©´ ì§€ë„ ì´ˆê¸°í™” ë° POI í‘œì‹œ
            if (tabId === 'step5') {
                setTimeout(() => {
                    initRecommendMap();
                    if (recommendMap) {
                        recommendMap.resize();
                    }
                    if (state.recommendations && state.recommendations.length > 0) {
                        displayPOIsOnMap(state.recommendations);
                    }
                }, 200);
            }
        }

        showTab('step1');

        // ê±°ì  ìœ„ì¹˜ ì§€ë„ ì´ˆê¸°í™”
        function initPositionMap() {
            if (positionMap) {
                positionMap.resize();
                return;
            }

            const mapContainer = document.getElementById('position-map');
            if (!mapContainer) {
                return;
            }

            positionMap = new mapboxgl.Map({
                container: 'position-map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [126.9780, 37.5665],
                zoom: 11
            });

            positionMap.addControl(new mapboxgl.NavigationControl());

            positionMap.on('load', () => {
                positionMap.resize();
            });
        }

        // ê±°ì  ìœ„ì¹˜ë¥¼ ì§€ë„ì— í‘œì‹œ
        function displayPositionOnMap(position) {
            if (!position || !position.geojson) {
                return;
            }

            if (!positionMap) {
                initPositionMap();
            }

            if (positionMap.isStyleLoaded()) {
                renderPosition(position);
            } else {
                positionMap.once('load', () => {
                    renderPosition(position);
                });
            }
        }

        // ì‹¤ì œ ì§€ë„ì— ê±°ì  ë Œë”ë§
        function renderPosition(position) {
            if (!positionMap) return;

            positionMap.resize();

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            if (positionMarker) {
                positionMarker.remove();
                positionMarker = null;
            }

            // ê¸°ì¡´ ë ˆì´ì–´/ì†ŒìŠ¤ ì œê±° (ë ˆì´ì–´ë¥¼ ë¨¼ì € ì œê±°í•œ í›„ ì†ŒìŠ¤ ì œê±°)
            if (positionMap.getLayer('position-fill-layer')) {
                positionMap.removeLayer('position-fill-layer');
            }
            if (positionMap.getLayer('position-layer')) {
                positionMap.removeLayer('position-layer');
            }
            if (positionMap.getSource('position-source')) {
                positionMap.removeSource('position-source');
            }
            if (positionMap.getSource('position-circle-source')) {
                positionMap.removeSource('position-circle-source');
            }

            const geojson = JSON.parse(position.geojson);

            // GeoJSON ì†ŒìŠ¤ ì¶”ê°€
            positionMap.addSource('position-source', {
                type: 'geojson',
                data: geojson
            });

            // íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
            if (position.geom_type === 'POLYGON' || position.geom_type === 'MULTIPOLYGON') {
                // í´ë¦¬ê³¤ ì±„ìš°ê¸°
                positionMap.addLayer({
                    id: 'position-fill-layer',
                    type: 'fill',
                    source: 'position-source',
                    paint: {
                        'fill-color': '#667eea',
                        'fill-opacity': 0.3
                    }
                });

                // í´ë¦¬ê³¤ í…Œë‘ë¦¬
                positionMap.addLayer({
                    id: 'position-layer',
                    type: 'line',
                    source: 'position-source',
                    paint: {
                        'line-color': '#667eea',
                        'line-width': 3
                    }
                });
            } else {
                // í¬ì¸íŠ¸ - ì¤‘ì‹¬ì  ë§ˆì»¤ë§Œ í‘œì‹œ
                const center = geojson.coordinates;

                // ì¤‘ì‹¬ì  ë§ˆì»¤
                positionMarker = new mapboxgl.Marker({ color: '#667eea' })
                    .setLngLat(center)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <strong>${position.name}</strong><br>
                        <small>ë°˜ê²½ 500m ê²€ìƒ‰</small>
                    `))
                    .addTo(positionMap);

                // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                positionMap.flyTo({
                    center: center,
                    zoom: 14,
                    duration: 1000
                });

                return;
            }

            // í´ë¦¬ê³¤ì˜ ê²½ìš° bounds ë§ì¶¤
            const bounds = new mapboxgl.LngLatBounds();
            const coords = geojson.type === 'Polygon'
                ? geojson.coordinates[0]
                : geojson.coordinates[0][0];

            coords.forEach(coord => bounds.extend(coord));

            positionMap.fitBounds(bounds, {
                padding: 50,
                duration: 1000
            });
        }

        // ì¶”ì²œê²€ìƒ‰ ì§€ë„ ì´ˆê¸°í™”
        function initRecommendMap() {
            if (recommendMap) {
                recommendMap.resize();
                return;
            }

            const mapContainer = document.getElementById('recommend-map');
            if (!mapContainer) {
                return;
            }

            recommendMap = new mapboxgl.Map({
                container: 'recommend-map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [126.9780, 37.5665],
                zoom: 11
            });

            recommendMap.addControl(new mapboxgl.NavigationControl());
        }

        // POI ì§€ë„ì— í‘œì‹œ
        function displayPOIsOnMap(pois) {
            if (!recommendMap || !pois || pois.length === 0) {
                return;
            }

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            recommendMarkers.forEach(marker => marker.remove());
            recommendMarkers = [];

            // POI ì •ë³´ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            let poiListHTML = '';
            const bounds = new mapboxgl.LngLatBounds();

            pois.forEach((poi, index) => {
                if (poi.mapx && poi.mapy) {
                    const lng = parseFloat(poi.mapx);
                    const lat = parseFloat(poi.mapy);

                    // ë§ˆì»¤ ìƒ‰ìƒ ê²°ì • (LIKE ë§¤ì¹­ = ë¹¨ê°•, Vector = íŒŒë‘)
                    const markerColor = poi.keyword_match_count > 0 ? '#f56565' : '#667eea';
                    const matchType = poi.keyword_match_count > 0 ? 'LIKE' : 'Vector';

                    // ë§ˆì»¤ ì¶”ê°€
                    const marker = new mapboxgl.Marker({ color: markerColor })
                        .setLngLat([lng, lat])
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <strong>${poi.title}</strong><br>
                            <small>${poi.addr1 || ''}</small><br>
                            <span style="color: ${markerColor}; font-weight: bold;">${matchType} ë§¤ì¹­</span>
                        `))
                        .addTo(recommendMap);

                    recommendMarkers.push(marker);
                    bounds.extend([lng, lat]);

                    // ì¶”ì²œ ì´ìœ  ìƒì„±
                    let reason = [];

                    // ë§¤ì¹­ ë°©ì‹
                    if (poi.keyword_match_count > 0) {
                        reason.push(`ğŸ¯ LIKE ê²€ìƒ‰ (í‚¤ì›Œë“œ ${poi.keyword_match_count}ê°œ ë§¤ì¹­)`);
                    } else if (poi.emotion_score > 0) {
                        reason.push(`ğŸ” Vector ê²€ìƒ‰ (ìœ ì‚¬ë„ ${(poi.emotion_score * 100).toFixed(0)}%)`);
                    }

                    // ê±°ë¦¬
                    if (poi.distance_km < 0.5) {
                        reason.push(`ğŸ“ ${(poi.distance_km * 1000).toFixed(0)}m`);
                    } else if (poi.distance_km) {
                        reason.push(`ğŸ“ ${poi.distance_km.toFixed(2)}km`);
                    }

                    // POI ì •ë³´ HTML
                    const cardBg = poi.keyword_match_count > 0 ? '#FFF5F5' : 'white';
                    const borderColor = poi.keyword_match_count > 0 ? '#f56565' : '#667eea';
                    const reasonBg = poi.keyword_match_count > 0 ? '#FED7D7' : '#f0f4ff';

                    poiListHTML += `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${cardBg}; border-radius: 6px; border-left: 4px solid ${borderColor};">
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">${index + 1}. ${poi.title}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${poi.addr1 || ''}</div>
                            ${reason.length > 0 ? `<div style="font-size: 11px; color: #333; margin-top: 5px; padding: 5px; background: ${reasonBg}; border-radius: 4px;">
                                <strong>ì¶”ì²œ ì´ìœ :</strong> ${reason.join(' Â· ')}
                            </div>` : ''}
                        </div>
                    `;
                }
            });

            // POI ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
            document.getElementById('poi-list').innerHTML = poiListHTML || '<p style="color: #999;">ìœ„ì¹˜ ì •ë³´ê°€ ì—†ëŠ” POIì…ë‹ˆë‹¤.</p>';

            // ì§€ë„ ë²”ìœ„ ë§ì¶¤
            if (!bounds.isEmpty()) {
                recommendMap.fitBounds(bounds, { padding: 50, duration: 1000 });
            }
        }

        // ìœ„ì¹˜ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
        function openLocationPicker() {
            const modal = document.getElementById('locationModal');
            modal.style.display = 'flex';

            // ì§€ë„ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (!pickerMap) {
                setTimeout(() => {
                    pickerMap = new mapboxgl.Map({
                        container: 'picker-map',
                        style: 'mapbox://styles/mapbox/streets-v12',
                        center: [126.9780, 37.5665],
                        zoom: 12
                    });

                    pickerMap.addControl(new mapboxgl.NavigationControl());

                    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
                    pickerMap.on('click', (e) => {
                        const { lng, lat } = e.lngLat;
                        selectedLng = lng;
                        selectedLat = lat;

                        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                        if (pickerMarker) {
                            pickerMarker.remove();
                        }

                        // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                        pickerMarker = new mapboxgl.Marker({ color: '#667eea' })
                            .setLngLat([lng, lat])
                            .addTo(pickerMap);

                        // ì¢Œí‘œ í‘œì‹œ
                        document.getElementById('selected-coords').textContent =
                            `ìœ„ë„: ${lat.toFixed(4)}, ê²½ë„: ${lng.toFixed(4)}`;
                    });
                }, 100);
            } else {
                pickerMap.resize();
            }
        }

        // ìœ„ì¹˜ ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
        function closeLocationPicker() {
            document.getElementById('locationModal').style.display = 'none';
        }

        // ì„ íƒí•œ ìœ„ì¹˜ í™•ì¸
        function confirmLocation() {
            if (selectedLat !== null && selectedLng !== null) {
                document.getElementById('userLat').value = selectedLat.toFixed(4);
                document.getElementById('userLng').value = selectedLng.toFixed(4);
                closeLocationPicker();
            } else {
                alert('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            }
        }

        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
        async function loadSystemPrompt() {
            try {
                const response = await fetch('http://localhost:8000/api/system-prompt');
                const data = await response.json();
                document.getElementById('system-prompt-editor').value = data.system_prompt || '';
            } catch (error) {
                console.error('Failed to load system prompt:', error);
                // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •
                document.getElementById('system-prompt-editor').value = `ë‹¹ì‹ ì€ ì„œìš¸ ê´€ê´‘ ì „ë¬¸ ì˜ë„ ë¶„ë¥˜, ìŠ¬ë¡¯ ì¶”ì¶œ, ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

ì˜ë„ ë¶„ë¥˜ ê°€ì´ë“œ:
1. FIND_PLACE: íŠ¹ì • ì¥ì†Œë¥¼ ì°¾ëŠ” ê²½ìš°
2. RECOMMEND: ì¶”ì²œì„ ìš”ì²­í•˜ëŠ” ê²½ìš°
3. ROUTE: ê²½ë¡œ/ê¸¸ì°¾ê¸°
4. EXPERIENCE: ì²´í—˜/íˆ¬ì–´
5. EVENT: í–‰ì‚¬/ì´ë²¤íŠ¸ ì •ë³´
6. RANDOM: ë¬´ì‘ìœ„ ì¶”ì²œ
7. GENERAL_CHAT: ì¼ë°˜ ëŒ€í™”

ìŠ¬ë¡¯ ì¶”ì¶œ ì›ì¹™:
- location_keyword: ëª…ì‹œì  ì¥ì†Œëª…ë§Œ ì¶”ì¶œ
- category_text: ì¹´í…Œê³ ë¦¬ ê´€ë ¨ ìì—°ì–´ ë°˜ë“œì‹œ ì¶”ì¶œ
- emotion: ê°ì •/ë¶„ìœ„ê¸° í‘œí˜„
- hard_constraints: ì ˆëŒ€ì  ì¡°ê±´ë“¤`;
            }
        }

        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì €ì¥
        async function saveSystemPrompt() {
            const newPrompt = document.getElementById('system-prompt-editor').value;

            try {
                const response = await fetch('http://localhost:8000/api/system-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_prompt: newPrompt })
                });

                if (response.ok) {
                    alert('ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Failed to save system prompt:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function loadRewritePrompt() {
            try {
                const response = await fetch('http://localhost:8000/api/rewrite-prompt');
                const data = await response.json();
                document.getElementById('rewrite-prompt-editor').value = data.system_prompt || '';
            } catch (error) {
                console.error('Failed to load rewrite prompt:', error);
            }
        }

        async function saveRewritePrompt() {
            const newPrompt = document.getElementById('rewrite-prompt-editor').value;

            try {
                const response = await fetch('http://localhost:8000/api/rewrite-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_prompt: newPrompt })
                });

                if (response.ok) {
                    alert('ë¦¬ë¼ì´íŠ¸ í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Failed to save rewrite prompt:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
        loadSystemPrompt();
        loadRewritePrompt();

        // ì „ì²´ ì‹¤í–‰ í•¨ìˆ˜
        async function runAll() {
            const query = document.getElementById('userQuery').value;
            if (!query) {
                alert('ì§ˆì˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            // ëª¨ë“  ì¹´ë“œ "ì‹¤í–‰ì¤‘" ìƒíƒœë¡œ ì´ˆê¸°í™”
            const cards = document.querySelectorAll('.step-card');
            for (let i = 1; i <= 6; i++) {
                const card = cards[i - 1];
                if (card) {
                    card.style.borderColor = '#667eea';
                    card.style.borderWidth = '3px';
                    card.style.backgroundColor = '#C3DAFE';
                    card.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.6)';
                }
                const statusEl = document.getElementById(`status${i}`);
                if (statusEl) {
                    statusEl.textContent = 'ëŒ€ê¸°ì¤‘...';
                    statusEl.className = 'status loading';
                }
            }

            try {
                // Step 1: ì˜ë„ë¶„ë¥˜
                await runStep1();

                // Step 2: ì¹´í…Œê³ ë¦¬ (ìˆì„ ê²½ìš°)
                if (state.classification?.category_text) {
                    await runStep2();
                }

                // Step 3: ìœ„ì¹˜ (ìˆì„ ê²½ìš°)
                if (state.classification?.location_keyword) {
                    await runStep3();
                }

                // Step 4: ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸
                await runStep4();

                // Step 5: ì¶”ì²œê²€ìƒ‰
                if (state.classification?.intent === 'RECOMMEND' || state.classification?.intent === 'FIND_PLACE') {
                    await runStep5();
                }

                // Step 6: ìµœì¢…ì‘ë‹µ
                await runStep6();

            } catch (error) {
                console.error('Pipeline error:', error);
                alert('ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // Step 1: ì˜ë„ë¶„ë¥˜/ìŠ¬ë¡¯ì¶”ì¶œ (Beaty ë‚´ì¥)
        async function runStep1() {
            const query = document.getElementById('userQuery').value;
            if (!query) {
                alert('ì§ˆì˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            state.query = query;
            setStatus(1, 'loading', 'ì‹¤í–‰ì¤‘...');

            try {
                const response = await fetch('http://localhost:8000/api/step1/classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                state.classification = data.classification;

                document.getElementById('json-step1').textContent = JSON.stringify(data, null, 2);
                setStatus(1, 'success', 'ì™„ë£Œ');
            } catch (error) {
                setStatus(1, 'error', 'ì‹¤íŒ¨: ' + error.message);
                document.getElementById('json-step1').textContent = 'Error: ' + error.message;
            }
        }

        // Step 2: ì¹´í…Œê³ ë¦¬ ì„ë² ë”© ê²°ê³¼ (Beaty ë‚´ì¥)
        async function runStep2() {
            if (!state.classification || !state.classification.category_text) {
                alert('ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            setStatus(2, 'loading', 'ì‹¤í–‰ì¤‘...');

            try {
                const response = await fetch('http://localhost:8000/api/step2/category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_text: state.classification.category_text
                    })
                });

                const data = await response.json();
                state.category = data.category;

                document.getElementById('json-step2').textContent = JSON.stringify(data, null, 2);
                setStatus(2, 'success', 'ì™„ë£Œ');
            } catch (error) {
                setStatus(2, 'error', 'ì‹¤íŒ¨: ' + error.message);
                document.getElementById('json-step2').textContent = 'Error: ' + error.message;
            }
        }

        // Step 3: ê±°ì  ì„ë² ë”© ê²°ê³¼ (Beaty ë‚´ì¥)
        async function runStep3() {
            if (!state.classification || !state.classification.location_keyword) {
                alert('ìœ„ì¹˜ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            setStatus(3, 'loading', 'ì‹¤í–‰ì¤‘...');

            try {
                const response = await fetch('http://localhost:8000/api/step3/position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location_keyword: state.classification.location_keyword
                    })
                });

                const data = await response.json();
                state.position = data.position;

                document.getElementById('json-step3').textContent = JSON.stringify(data, null, 2);
                setStatus(3, 'success', 'ì™„ë£Œ');
            } catch (error) {
                setStatus(3, 'error', 'ì‹¤íŒ¨: ' + error.message);
                document.getElementById('json-step3').textContent = 'Error: ' + error.message;
            }
        }

        // Step 4: ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸ (ìš”ì²­ JSON ìƒì„±)
        async function runStep4() {
            setStatus(4, 'loading', 'ì‹¤í–‰ì¤‘...');

            try {
                const lat = parseFloat(document.getElementById('userLat').value);
                const lng = parseFloat(document.getElementById('userLng').value);

                // GPT ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸ API í˜¸ì¶œ
                const requestData = {
                    query: state.query,
                    intent: state.classification?.intent || 'RECOMMEND',
                    category: state.category ? {
                        cat_code: state.category.cat_code,
                        cat_level: state.category.cat_level,
                        content_type_id: state.category.content_type_id
                    } : null,
                    geometry_id: state.position ? state.position.geometry_id : null,
                    user_location: lat && lng ? { lat, lng } : null,
                    hard_constraints: state.classification?.hard_constraints || [],
                    emotion: state.classification?.emotion || null
                };

                const response = await fetch('http://localhost:8000/api/step4/rewrite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                const rewrittenData = data.rewritten_query;

                // Step 5ë¥¼ ìœ„í•œ ìš”ì²­ ë°ì´í„° êµ¬ì„±
                const rewrittenQuery = {
                    query_text: rewrittenData.query_text,
                    category: state.category ? {
                        cat_code: state.category.cat_code,
                        cat_level: state.category.cat_level,
                        content_type_id: String(state.category.content_type_id)
                    } : null,
                    geometry_id: state.position ? state.position.geometry_id : null,
                    user_location: lat && lng ? { lat, lng } : null,
                    filters: (rewrittenData.filters && Object.keys(rewrittenData.filters).length > 0) ? rewrittenData.filters : null,
                    preferences: (rewrittenData.preferences && Object.keys(rewrittenData.preferences).length > 0) ? rewrittenData.preferences : null,
                    core_keywords: (rewrittenData.core_keywords && rewrittenData.core_keywords.length > 0) ? rewrittenData.core_keywords : null,
                    limit: 10
                };

                state.rewrittenQuery = rewrittenQuery;

                // Step 4 ê²°ê³¼: GPT ë¦¬ë¼ì´íŠ¸ ê²°ê³¼ + ì‹¤ì œ Step 5ë¡œ ë³´ë‚¼ ì „ì²´ ë°ì´í„°
                const step4Result = {
                    gpt_rewrite: data.rewritten_query,
                    final_request_to_step5: rewrittenQuery
                };

                document.getElementById('json-step4').textContent = JSON.stringify(step4Result, null, 2);
                setStatus(4, 'success', 'ì™„ë£Œ');
            } catch (error) {
                setStatus(4, 'error', 'ì‹¤íŒ¨: ' + error.message);
                document.getElementById('json-step4').textContent = 'Error: ' + error.message;
            }
        }

        // Step 5: ì¶”ì²œ ì„œë¹„ìŠ¤ ê²°ê³¼ (Beaty -> Recommend ì„œë¹„ìŠ¤)
        async function runStep5() {
            console.log('[runStep5] Called');
            console.log('[runStep5] state.rewrittenQuery:', state.rewrittenQuery);
            setStatus(5, 'loading', 'ì‹¤í–‰ì¤‘...');

            try {
                if (!state.rewrittenQuery) {
                    throw new Error('ì¿¼ë¦¬ ë¦¬ë¼ì´íŠ¸ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤');
                }

                console.log('[runStep5] Sending request...');
                const response = await fetch('http://localhost:8000/api/step5/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state.rewrittenQuery)
                });

                const data = await response.json();
                console.log('[runStep5] Response:', data);
                state.recommendations = data.pois;

                document.getElementById('json-step5').textContent = JSON.stringify(data, null, 2);
                setStatus(5, 'success', `ì™„ë£Œ (${data.count}ê°œ)`);
                console.log('[runStep5] Done, count:', data.count);

                // POIë¥¼ ì§€ë„ì— í‘œì‹œ
                if (data.pois && data.pois.length > 0) {
                    // ì§€ë„ ì´ˆê¸°í™”
                    if (!recommendMap) {
                        initRecommendMap();
                    }
                    // POI í‘œì‹œ
                    setTimeout(() => {
                        if (recommendMap) {
                            recommendMap.resize();
                            displayPOIsOnMap(data.pois);
                        }
                    }, 100);
                }
            } catch (error) {
                setStatus(5, 'error', 'ì‹¤íŒ¨: ' + error.message);
                document.getElementById('json-step5').textContent = 'Error: ' + error.message;
            }
        }

        // Step 6: ìµœì¢… ì‘ë‹µ (ì „ì²´ íŒŒì´í”„ë¼ì¸)
        async function runStep6() {
            setStatus(6, 'loading', 'ì‹¤í–‰ì¤‘...');

            try {
                // Step 5 ê²°ê³¼ë¥¼ ì‚¬ìš©í•˜ì—¬ ìì—°ì–´ ì‘ë‹µë§Œ ìƒì„±
                const requestData = {
                    query: state.query,
                    intent: state.classification?.intent || 'RECOMMEND',
                    pois: state.recommendations || [],
                    classification: state.classification || {}
                };

                const response = await fetch('http://localhost:8000/api/step6/generate-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                state.finalResponse = data;

                document.getElementById('json-step6').textContent = JSON.stringify(data, null, 2);
                setStatus(6, 'success', 'ì™„ë£Œ');
            } catch (error) {
                setStatus(6, 'error', 'ì‹¤íŒ¨: ' + error.message);
                document.getElementById('json-step6').textContent = 'Error: ' + error.message;
            }
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function setStatus(step, type, message) {
            const statusEl = document.getElementById(`status${step}`);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;

            // Step ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ (í˜„ì¬ Stepë§Œ ì—…ë°ì´íŠ¸, ë‹¤ë¥¸ ì¹´ë“œëŠ” ìœ ì§€)
            const cards = document.querySelectorAll('.step-card');
            const currentCard = cards[step - 1];

            if (currentCard) {
                currentCard.classList.add('active');
                if (type === 'loading') {
                    currentCard.style.borderColor = '#667eea';
                    currentCard.style.borderWidth = '3px';
                    currentCard.style.backgroundColor = '#C3DAFE';
                    currentCard.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.6)';
                } else if (type === 'success') {
                    currentCard.style.borderColor = '#48bb78';
                    currentCard.style.borderWidth = '3px';
                    currentCard.style.backgroundColor = '#C6F6D5';
                    currentCard.style.boxShadow = '0 4px 12px rgba(72, 187, 120, 0.6)';
                } else if (type === 'error') {
                    currentCard.style.borderColor = '#f56565';
                    currentCard.style.borderWidth = '3px';
                    currentCard.style.backgroundColor = '#FED7D7';
                    currentCard.style.boxShadow = '0 4px 12px rgba(245, 101, 101, 0.6)';
                } else {
                    currentCard.style.borderColor = '';
                    currentCard.style.borderWidth = '';
                    currentCard.style.backgroundColor = '';
                    currentCard.style.boxShadow = '';
                }
            }
        }

        // ì „ì²´ ì´ˆê¸°í™”
        function clearAll() {
            if (!confirm('ëª¨ë“  ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            state.query = '';
            state.classification = null;
            state.category = null;
            state.position = null;
            state.rewrittenQuery = null;
            state.recommendations = null;
            state.finalResponse = null;

            for (let i = 1; i <= 6; i++) {
                setStatus(i, '', 'ëŒ€ê¸°ì¤‘');
                document.getElementById(`json-step${i}`).textContent = 'ê²°ê³¼ ì—†ìŒ';
            }

            showTab('step1');
        }
    </script>
</body>
</html>
